<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Schedule - Robs Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            color-scheme: light dark;
        }
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* Light Mode */
        body.light-mode {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #1f2937;
        }
        body.light-mode .container {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        body.light-mode h1 {
            color: #1e40af;
        }
        body.light-mode #day-selector {
            background-color: #f9fafb;
            border-color: #d1d5db;
            color: #1f2937;
        }
        body.light-mode table th {
            background-color: #e5e7eb;
            color: #1f2937;
            border-color: #d1d5db;
        }
        body.light-mode table td {
            border-color: #e5e7eb;
            color: #1f2937;
        }
        body.light-mode table tr:nth-child(even) td {
            background-color: #f9fafb;
        }
        body.light-mode table tr:hover td {
            background-color: #dbeafe;
        }
        body.light-mode .highlight {
            background-color: #fef08a !important;
            color: #1f2937 !important;
        }
        body.light-mode .mode-toggle {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        body.light-mode .mode-toggle:hover {
            background-color: #d1d5db;
        }
        body.light-mode .back-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        body.light-mode .back-btn:hover {
            background-color: #d1d5db;
        }
        body.light-mode #current-task {
            color: #4b5563;
        }

        /* Dark Mode */
        body.dark-mode {
            background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            color: #e5e7eb;
        }
        body.dark-mode .container {
            background: rgba(17, 24, 39, 0.95);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(75, 85, 99, 0.2);
        }
        body.dark-mode h1 {
            color: #60a5fa;
        }
        body.dark-mode #day-selector {
            background-color: #1f2937;
            border-color: #4b5563;
            color: #e5e7eb;
        }
        body.dark-mode table th {
            background-color: #1f2937;
            color: #93c5fd;
            border-color: #4b5563;
        }
        body.dark-mode table td {
            border-color: #4b5563;
            color: #dbeafe;
        }
        body.dark-mode table tr:nth-child(even) td {
            background-color: rgba(31, 41, 55, 0.5);
        }
        body.dark-mode table tr:hover td {
            background-color: rgba(96, 165, 250, 0.1);
        }
        body.dark-mode .highlight {
            background-color: rgba(234, 179, 8, 0.2) !important;
            color: #e5e7eb !important;
            border-left: 3px solid #eab308;
        }
        body.dark-mode .mode-toggle {
            background-color: #374151;
            color: #93c5fd;
            border: 1px solid #4b5563;
        }
        body.dark-mode .mode-toggle:hover {
            background-color: #4b5563;
        }
        body.dark-mode .back-btn {
            background-color: #374151;
            color: #93c5fd;
            border: 1px solid #4b5563;
        }
        body.dark-mode .back-btn:hover {
            background-color: #4b5563;
        }
        body.dark-mode #current-task {
            color: #9ca3af;
        }

        /* Shared Styles */
        body {
            min-height: 100vh;
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .container {
            width: 95%;
            max-width: 920px;
            margin: 2rem auto;
            padding: 24px;
            border-radius: 14px;
            overflow-x: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        h1 {
            font-size: 2em;
            margin: 0;
            font-weight: 800;
        }
        .header-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .mode-toggle, .back-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid;
        }
        .mode-toggle:hover, .back-btn:hover {
            opacity: 0.85;
        }
        #current-task {
            font-size: 1.1em;
            margin: 12px 0;
            font-weight: 500;
            font-style: italic;
        }
        .day-selector-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
        }
        @media (min-width: 768px) {
            .day-selector-wrapper {
                flex-direction: row;
            }
        }
        .day-selector-wrapper label {
            font-weight: 600;
            font-size: 1em;
        }
        #day-selector {
            padding: 10px 12px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid;
            font-weight: 500;
            flex: 1;
            min-width: 150px;
            outline: none;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 1em;
        }
        th, td {
            padding: 12px 10px;
            text-align: left;
            border: 1px solid;
            word-wrap: break-word;
        }
        th {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            font-size: 0.9em;
        }
        tr:hover td {
            cursor: default;
        }
        footer {
            margin-top: 24px;
            font-size: 0.875em;
            text-align: center;
            opacity: 0.7;
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .header-controls {
                width: 100%;
            }
            .container {
                padding: 16px;
            }
            h1 {
                font-size: 1.5em;
            }
            #day-selector {
                width: 100%;
            }
            th, td {
                padding: 8px 6px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="protected-content" style="display:none">
    <div class="container">
        <div class="header">
            <h1>Weekly Schedule</h1>
            <div class="header-controls">
                <button id="mode-toggle" class="mode-toggle" aria-label="Toggle dark/light mode">☀️</button>
                <button onclick="history.back()" class="back-btn" title="Go Back">&larr; Back</button>
            </div>
        </div>

        <div class="day-selector-wrapper">
            <label for="day-selector">Select Day:</label>
            <select id="day-selector" aria-label="Select a day to view schedule">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
        </div>

        <p id="current-task"></p>

            <div style="text-align: center; margin: 16px 0; padding: 12px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                <div style="font-size: 0.875em; opacity: 0.8;">Current Time (WAT)</div>
                <div id="current-time" style="font-size: 1.75em; font-weight: 700; font-family: 'Courier New', monospace; margin-top: 4px;">--:--:--</div>
            </div>

        <table id="schedule-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Task / Event</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <footer>&copy; Robs Hub &mdash; Schedule refreshes in real-time.</footer>
    </div>
    </div>

    <script src="../assets/theme.js"></script>
    <script src="../assets/auth.js"></script>
    <script>

        // ============ SCHEDULE DATA (NEW "FIRST-CLASS FOCUS" SCHEDULE) ============
        const schedule = {
            "Monday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "7:00 AM - 9:00 AM": "INTERMEDIATE MICROECONOMICS",
                "9:00 AM - 11:00 AM": "HISTORY OF ECONOMIC THOUGHT",
                "11:00 AM - 1:00 PM": "Free / Lunch Prep",
                "1:00 PM - 2:00 PM": "CAF - FRIED RICE",
                "2:00 PM - 3:00 PM": "Review: INTERMEDIATE MICRO",
                "3:00 PM - 3:15 PM": "Break",
                "3:15 PM - 4:15 PM": "Review: HISTORY OF ECONOMIC THOUGHT",
                "4:15 PM - 6:00 PM": "Free / Break",
                "6:00 PM - 7:00 PM": "CAF - POTATO AND EGG SAUCE",
                "7:30 PM - 9:30 PM": "Cumulative Review: INNOVATIONS IN SOC. SCIENCES"
            },
            "Tuesday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "8:00 AM - 10:00 AM": "INNOVATIONS IN THE SOCIAL SCIENCES",
                "10:00 AM - 11:00 AM": "Review: INNOVATIONS (Day 1)",
                "11:00 AM - 1:00 PM": "INTERMEDIATE MACROECONOMICS",
                "1:00 PM - 2:00 PM": "CAF - SWALLOW",
                "2:00 PM - 4:00 PM": "OPERATION RESEARCH",
                "4:00 PM - 5:00 PM": "FUNDAMENTALS OF CHRISTIAN FAITH",
                "5:00 PM - 6:00 PM": "CAF - RICE & BEANS",
                "6:00 PM - 7:30 PM": "Hall Worship",
                "7:30 PM - 8:30 PM": "Review: INTERMEDIATE MACRO",
                "8:30 PM - 8:45 PM": "Break",
                "8:45 PM - 9:30 PM": "Review: OPERATION RESEARCH",
                "9:30 PM - 9:45 PM": "Break",
                "9:45 PM - 10:30 PM": "Review: FCF (Day 1)"
            },
            "Wednesday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "7:00 AM - 9:00 AM": "FUNDAMENTALS OF CHRISTIAN FAITH",
                "9:00 AM - 10:00 AM": "BIS",
                "10:00 AM - 10:30 AM": "Break",
                "10:30 AM - 12:30 PM": "Weekly Skill Focus {Blockchain, R+, Indices, Cyber}",
                "1:00 PM - 2:00 PM": "CAF - BEANS",
                "2:00 PM - 4:00 PM": "PROJECT EVALUATION",
                "4:00 PM - 5:00 PM": "Free",
                "5:00 PM - 6:00 PM": "CAF - SPAG",
                "6:00 PM - 7:00 PM": "CHURCH",
                "7:30 PM - 8:30 PM": "Review: FCF (Wed class)",
                "8:30 PM - 8:45 PM": "Break",
                "8:45 PM - 9:45 PM": "Review: PROJECT EVALUATION"
            },
            "Thursday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "7:00 AM - 9:00 AM": "DATA ANALYSIS USING ADVANCED EXCEL...",
                "9:00 AM - 11:00 AM": "ENVIRONMENTAL ECONOMICS",
                "11:00 AM - 1:00 PM": "Free / Lunch Prep",
                "1:00 PM - 2:00 PM": "CAF - SWALLOW",
                "2:30 PM - 3:30 PM": "Review: DATA ANALYSIS...",
                "3:30 PM - 3:45 PM": "Break",
                "3:45 PM - 4:45 PM": "Review: ENVIRONMENTAL ECONOMICS",
                "4:45 PM - 6:00 PM": "Free",
                "6:00 PM - 7:00 PM": "CAF - MIXED RICE",
                "7:30 PM - 9:30 PM": "Cumulative Review: HISTORY OF ECONOMIC THOUGHT"
            },
            "Friday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "7:00 AM - 9:00 AM": "Free",
                "9:00 AM - 11:00 AM": "General Assignment Block",
                "11:00 AM - 1:00 PM": "Free / Lunch Prep",
                "1:00 PM - 2:00 PM": "CAF - BEANS",
                "2:30 PM - 5:00 PM": "Weekly Skill Focus {Blockchain, R+, Indices, Cyber}",
                "5:00 PM - 6:00 PM": "CAF - YAM & STEW",
                "6:00 PM - 7:00 PM": "CHURCH",
                "7:30 PM - 9:30 PM": "Cumulative Review: OPERATION RESEARCH"
            },
            "Saturday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "7:00 AM - 9:00 AM": "Free",
                "9:00 AM - 11:00 AM": "CHURCH",
                "11:00 AM - 1:00 PM": "CAF - JOLLOF RICE",
                "1:00 PM - 2:00 PM": "Free",
                "2:00 PM - 4:00 PM": "Cumulative Review: INTERMEDIATE MACROECONOMICS",
                "4:00 PM - 6:00 PM": "Cumulative Review: DATA ANALYSIS...",
                "6:00 PM - 7:00 PM": "CAF - FRIED YAM",
                "7:30 PM - 9:30 PM": "Cumulative Review: ENVIRONMENTAL ECONOMICS"
            },
            "Sunday": {
                "6:00 AM - 7:00 AM": "Wake up, Pray & Bible Study",
                "8:00 AM - 10:00 AM": "Cumulative Review: INTERMEDIATE MICROECONOMICS",
                "10:00 AM - 12:00 PM": "General Assignment Block",
                "12:00 PM - 12:30 PM": "Free",
                "12:30 PM - 1:30 PM": "CAF - BEANS (Light Lunch)",
                "1:30 PM - 2:30 PM": "Free",
                "2:30 PM - 5:00 PM": "Weekly Skill Focus {Blockchain, R+, Indices, Cyber}",
                "5:00 PM - 6:00 PM": "Free",
                "6:00 PM - 7:00 PM": "CAF - RICE AND STEW",
                "7:30 PM - 9:00 PM": "Cumulative Review: PROJECT EVALUATION"
            }
        }

        // ============ UTILITY FUNCTIONS ============
        const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        function getCurrentWATTime() {
            const now = new Date();
            // WAT is UTC+1. Assuming server or local time is correct.
            // Let's use the local time and assume it's set to WAT.
            // For forced WAT (UTC+1):
            const offset = 1; // WAT is UTC+1
            const localDate = new Date();
            const utc = localDate.getTime() + (localDate.getTimezoneOffset() * 60000);
            const watDate = new Date(utc + (3600000 * offset));
            return watDate;
        }

        function getTodayName() {
            return daysOfWeek[getCurrentWATTime().getDay()];
        }

        function parseTime(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const [time, period] = timeStr.toLowerCase().trim().split(' ');
            if (!time || !period) return 0;
            let [hours = 0, minutes = 0] = time.split(':').map(Number);
            if (isNaN(hours)) return 0;
            if (period === 'pm' && hours < 12) hours += 12;
            if (period === 'am' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        }

        function getCurrentTimeInMinutes() {
            const now = getCurrentWATTime();
            return now.getHours() * 60 + now.getMinutes();
        }

        // ============ SCHEDULE RENDERING ============
        const daySelector = document.getElementById('day-selector');
        const tableBody = document.querySelector('#schedule-table tbody');
        const currentTaskElement = document.getElementById('current-task');

        // ============ CURRENT TIME DISPLAY ============
        const currentTimeElement = document.getElementById('current-time');
        
        function updateCurrentTimeDisplay() {
            const now = getCurrentWATTime();
            let hours = now.getHours();
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            if (hours === 0) hours = 12;
            currentTimeElement.textContent = `${hours}:${minutes}:${seconds} ${ampm}`;
        }
        
        // Update time immediately and then every second
        updateCurrentTimeDisplay();
        setInterval(updateCurrentTimeDisplay, 1000);

        function renderSchedule() {
            const selectedDay = daySelector.value;
            tableBody.innerHTML = '';

            if (!schedule[selectedDay]) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.textContent = 'No schedule for this day';
                cell.style.textAlign = 'center';
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const todayName = getTodayName();
            const isToday = selectedDay === todayName;
            const currentTime = getCurrentTimeInMinutes();

            Object.entries(schedule[selectedDay]).forEach(([time, task]) => {
                const row = document.createElement('tr');

                const timeCell = document.createElement('td');
                timeCell.textContent = time;
                timeCell.style.fontWeight = '600';

                const taskCell = document.createElement('td');
                taskCell.textContent = task;

                row.appendChild(timeCell);
                row.appendChild(taskCell);

                // Highlight current task if viewing today
                if (isToday) {
                    // Support time ranges with AM/PM in both start and end
                    let [startStr, endStr] = time.split(' - ');
                    // If endStr is missing AM/PM, inherit from startStr
                    if (startStr && endStr && !/(am|pm)/i.test(endStr) && /(am|pm)/i.test(startStr)) {
                        const match = startStr.match(/(am|pm)/i);
                        if (match) endStr = endStr + ' ' + match[1];
                    }
                    const startTime = parseTime(startStr);
                    const endTime = parseTime(endStr);
                   
                    if (currentTime >= startTime && currentTime < endTime) { // Use < endTime
                        row.classList.add('highlight');
                    }
                }

                tableBody.appendChild(row);
            });
        }

        // ============ HELPER FOR DYNAMIC TASKS (Not used for Pomodoro anymore) ============
        const studiableTasks = [
            'study', 'reading', 'school stuff', 'assignments', 'project',
            'cyber security', 'ai', 'linux', 'networking', 'db', 'database', 'data structures'
        ];

        // ============ (MODIFIED) DYNAMIC CURRENT TASK ============
        function updateCurrentTask() {
            const todayName = getTodayName();
            const selectedDay = daySelector.value;
            const currentTime = getCurrentTimeInMinutes();

            if (selectedDay !== todayName) {
                currentTaskElement.textContent = 'Viewing schedule for a different day.';
                return;
            }

            const dayTasks = schedule[selectedDay];
            if (!dayTasks) {
                currentTaskElement.textContent = 'No schedule for today.';
                return;
            }

            let foundCurrent = false;
            for (const [time, task] of Object.entries(dayTasks)) {
                let [startStr, endStr] = time.split(' - ');
                // If endStr is missing AM/PM, inherit from startStr
                if (startStr && endStr && !/(am|pm)/i.test(endStr) && /(am|pm)/i.test(startStr)) {
                    const match = startStr.match(/(am|pm)/i);
                    if (match) endStr = endStr + ' ' + match[1];
                }
                const startTime = parseTime(startStr);
                const endTime = parseTime(endStr);

                // CHECK IF THIS IS THE CURRENT TASK
                if (currentTime >= startTime && currentTime < endTime) { // Use < endTime
                    foundCurrent = true;
                    
                    // --- "SMART" LOGIC DISABLED ---
                    // The new schedule has breaks built-in, so we don't
                    // want the old Pomodoro logic to interfere.
                    // We will just display the task as-is.
                    currentTaskElement.innerHTML = `<strong>Current Task:</strong> ${task}`;
                    
                    break; // Exit loop once task is found
                }
            }

            if (!foundCurrent) {
                currentTaskElement.textContent = 'You are currently in a free block.';
            }
        }

        // ============ INITIALIZATION ============

        // Put page startup logic into a single function and run it only after auth
        function startApp() {
            // 1. Initialize the page
            daySelector.value = getTodayName();
            renderSchedule();
            updateCurrentTask();

            // 2. NOW we can add the event listeners
            // Update on day change
            daySelector.addEventListener('change', () => {
                renderSchedule();
                updateCurrentTask();
            });

            // Update current task every minute
            setInterval(() => {
                updateCurrentTask();
                renderSchedule(); // Re-render to update highlight
            }, 60000);

            // Update when window regains focus
            window.addEventListener('focus', () => {
                renderSchedule();
                updateCurrentTask();
            });
        }

        // Listen for the auth success event from the shared auth module
        document.addEventListener('auth:unlocked', () => {
            try { startApp(); } catch (e) { console.error('startApp failed after auth', e); }
        });

        // If the protected content is already visible (session-based), initialize now
        if (document.getElementById('protected-content') && document.getElementById('protected-content').style.display !== 'none') {
            startApp();
        }
    </script>
</body>
</html>